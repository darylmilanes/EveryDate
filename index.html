<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- 
      Viewport meta tag:
      - 'width=device-width, initial-scale=1.0' sets the viewport to the device's width.
      - 'maximum-scale=1.0' is crucial for iOS to prevent zooming in on form inputs.
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA and iOS Home Screen Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EveryDate">
    <meta name="theme-color" content="#004080">

    <title>EveryDate</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.395.0/dist/umd/lucide.js"></script>

    <!-- Google Font (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- App icons & manifest -->
    <!-- Apple/iOS: prefer apple-touch-icon (iOS ignores manifest icons) -->
    <link rel="apple-touch-icon" sizes="180x180" href="icon-512.png?v=2">
    <!-- Fallback favicon / shortcut -->
    <link rel="shortcut icon" href="icon-192.png?v=2">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png?v=2">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png?v=2">
    <!-- Manifest (cache-busted) -->
    <link rel="manifest" href="manifest.json?v=2">
    <!-- Chrome maskable icon for Android -->
    <link rel="mask-icon" href="icon-512.png?v=2" color="#004080">
    <meta name="theme-color" content="#004080">

    <style>
        /* Define custom color properties from the prompt */
        :root {
            --color-primary: #004080; /* Dark Blue */
            --color-secondary: #474747; /* Dark Gray */
            --color-bg: #fafeff; /* Almost White */
            --color-bg-gradient: linear-gradient(135deg, #fafeff 0%, #e6f7ff 100%);
        }

        /* Set the base font and background */
        html {
            font-family: 'Inter', sans-serif;
        }
        body {
            background: var(--color-bg-gradient);
            color: var(--color-secondary);
        }

        /* The "Liquid Glass" Style 
          This class will be applied to headers, the tab bar, and modals.
        */
        .glass-card {
            background: rgba(255, 255, 255, 0.65);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            /* Subtle shadow using the primary color */
            box-shadow: 0 8px 32px 0 rgba(0, 64, 128, 0.1);
        }

        /* iOS Input Fix 
          font-size: 16px is required to prevent iOS from auto-zooming on focus.
        */
        .ios-input {
            font-size: 16px !important;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(209, 213, 219, 0.5);
            border-radius: 10px;
            padding: 12px;
            width: 100%;
        }
        .ios-input:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: -1px;
            border-color: transparent;
        }

        /* Active Tab Button Style */
        .tab-button.active {
            color: var(--color-primary);
            transform: translateY(-4px);
        }
        .tab-button.active .icon {
            background-color: var(--color-primary);
            color: var(--color-bg);
            border-radius: 50%;
            padding: 4px;
        }

        /* Calendar Day Styles */
        .calendar-day {
            transition: all 0.2s ease-in-out;
        }
        .calendar-day.today {
            background-color: var(--color-primary);
            color: #edb11b; /* medium dark yellow */
            border-radius: 50%;
        }
        .calendar-day.selected {
            border: 2px solid var(--color-primary);
            border-radius: 50%;
            background-color: rgba(0, 64, 128, 0.1);
        }
        .calendar-day.other-month {
            opacity: 0.3;
        }
        .calendar-day .reminder-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            margin: 1px;
        }

        /* Modal Styles */
        #reminder-modal {
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform: translateY(110%);
            box-sizing: border-box;
        }
        #reminder-modal.is-open {
            transform: translateY(0);
        }

        /* Slightly tighten inner form spacing so content appears compressed */
        #reminder-modal .ios-input {
            padding: 10px !important;
        }
        #reminder-modal .flex-grow.min-w-0 {
            padding-right: 0.25rem;
        }

        /* Color Preset Button Styles */
        .color-preset {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .color-preset.selected {
            transform: scale(1.15);
            box-shadow: 0 0 0 3px var(--color-bg), 0 0 0 5px var(--color-primary);
        }
        /* Layout for one row of color presets */
        #color-selector {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
            /* Add extra bottom margin so color rows don't sit tight against buttons */
            margin-bottom: 1rem;
            gap: 12px; /* slightly larger gap between color items */
        }
        .color-row {
            display: flex;
            gap: 8px;
            justify-content: space-around;
            /* Ensure each color row has breathing room */
            margin-bottom: 0.5rem;
        }

        /* Modal footer spacing helper */
        .modal-actions {
            padding-top: 1.25rem; /* slightly larger than default to add breathing room */
        }

        /* Reminder card two-line constraint */
        .reminder-item .reminder-title {
            font-weight: 600;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .reminder-item .reminder-details {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--color-primary);
            font-size: 0.875rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .reminder-item .category-inline {
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            color: inherit;
            margin-left: 6px;
            flex-shrink: 0;
            display: inline-block;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.06);
            background-color: transparent; /* inline style will set matching color */
        }
        
        /* Drag and Drop Styles */
        .reminder-item.dragging {
            opacity: 0.5;
            background: rgba(0, 64, 128, 0.1);
        }
        .reminder-item.drag-over {
            transform: scale(1.02);
            border-top: 2px solid var(--color-primary);
        }

        /* [NEW] Prevent selection/menu on hold in reminders list */
        #reminders-list .reminder-item {
            -webkit-touch-callout: none; /* iOS: Disable context menu */
            -webkit-user-select: none;   /* Safari */
            -moz-user-select: none;      /* Firefox */
            -ms-user-select: none;       /* IE */
            user-select: none;           /* Standard */
        }

        /* Drag floating clone and placeholder styles */
        .dragging-floating {
            box-shadow: 0 12px 30px rgba(0,0,0,0.18);
            transform: translateY(-6px) scale(1.02);
            border-radius: 12px;
            opacity: 0.98;
            transition: none !important;
            will-change: transform, top, left;
        }
        .reminder-placeholder {
            background: rgba(0,0,0,0.03);
            border-radius: 8px;
            margin: 4px 0;
            box-sizing: border-box;
        }

        /* Add consistent color accent and spacing for reminder items */
        .reminder-item {
            margin-bottom: 0.5rem; /* global spacing between reminder items */
        }
        /* Extra vertical spacing specifically in calendar view */
        #calendar-reminders-list .reminder-item {
            margin-bottom: 0.5rem;
        }
        #calendar-reminders-list .reminder-item .reminder-item-content {
            padding: 8px 10px; /* smaller padding */
            border-radius: 8px;
            min-height: 38px; /* reduce overall box height */
            display: flex;
            align-items: center;
        }
        #calendar-reminders-list .reminder-item .reminder-title {
            font-size: 0.95rem; /* slightly smaller title */
            font-weight: 600;
            line-height: 1;
        }
        #calendar-reminders-list .reminder-item .reminder-details {
            font-size: 0.75rem; /* smaller details */
            gap: 6px;
        }
        #calendar-reminders-list .reminder-item .reminder-details i {
            width: 14px;
            height: 14px;
            margin-right: 6px;
        }
        #calendar-reminders-list .reminder-item .category-inline {
            padding: 1px 6px;
            font-size: 0.65rem;
            margin-left: 4px;
        }

        /* [NEW] Swipe to Delete Styles */
        .reminder-item {
            position: relative;
            overflow: hidden; /* Important for swipe effect */
        }
        .reminder-item-content {
            position: relative;
            z-index: 10;
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            /* This div holds the glass-card style now */
            background: rgba(255, 255, 255, 0.65);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(0, 64, 128, 0.1);
        }
        .swipe-delete {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 80px; /* Width of the delete button */
            background-color: #FF6B6B; /* Red */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            transform: translateX(100%); /* Hidden by default */
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        /* When the item is swiped, show the delete button */
        .reminder-item.swiped .swipe-delete {
            transform: translateX(0);
        }
        /* When the item is swiped, move the content */
        .reminder-item.swiped .reminder-item-content {
            transform: translateX(-80px); /* Move content left by button width */
        }


        /* Disable text selection and iOS long-press menu for items in the All Reminders list */
        #reminders-list .reminder-item {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none; /* iOS long-press menu */
            -webkit-user-drag: none;
            touch-action: pan-y; /* allow vertical scrolling while preventing unwanted gestures */
        }

        /* Hide scrollbar */
        ::-webkit-scrollbar {
            display: none;
        }
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
    </style>
</head>
<body class="overscroll-none">

    <!-- 
      App container: 
      [FIX] Use h-dvh (dynamic viewport height) for better mobile sizing
    -->
    <div id="app-container" class="relative h-dvh w-screen max-w-lg mx-auto flex flex-col shadow-2xl overflow-hidden bg-[#fafeff]">

        <!-- Main Content Area 
          [FIX] Removed overflow-y-auto, child pages will control their own scrolling
        -->
        <main class="flex-grow pb-24 min-h-0"> <!-- Padding-bottom for the tab bar -->

            <!-- ===== CALENDAR PAGE (Default View) ===== -->
            <!-- [FIX] Added h-full and flex-col to make child elements scrollable -->
            <div id="calendar-page" class="h-full flex flex-col">
                <!-- Glass Header -->
                <header class="glass-card sticky top-0 z-10 px-4 py-3 rounded-b-2xl flex-shrink-0">
                    <h1 class="text-2xl font-bold text-center" style="color: var(--color-primary);">Calendar</h1>
                </header>

                <!-- [FIX] Added flex-shrink: 0 to calendar grid area -->
                <div class="p-4 flex-shrink-0">
                    <!-- Calendar Controls -->
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 transition">
                            <i data-lucide="chevron-left" class="text-gray-600"></i>
                        </button>
                        <h2 id="month-year" class="text-xl font-semibold text-center" style="color: var(--color-primary);"></h2>
                        <button id="next-month" class="p-2 rounded-full hover:bg-gray-200 transition">
                            <i data-lucide="chevron-right" class="text-gray-600"></i>
                        </button>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 gap-1 text-center mb-4">
                        <!-- Day headers -->
                        <div class="font-semibold text-xs text-gray-500">SUN</div>
                        <div class="font-semibold text-xs text-gray-500">MON</div>
                        <div class="font-semibold text-xs text-gray-500">TUE</div>
                        <div class="font-semibold text-xs text-gray-500">WED</div>
                        <div class="font-semibold text-xs text-gray-500">THU</div>
                        <div class="font-semibold text-xs text-gray-500">FRI</div>
                        <div class="font-semibold text-xs text-gray-500">SAT</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                        <!-- Calendar days will be generated by JS -->
                    </div>
                </div>

                <!-- Reminders for selected day -->
                <!-- [FIX] This container will scroll if content overflows -->
                <div class="px-4 flex-grow min-h-0 flex flex-col">
                    <h3 id="selected-day-header" class="text-lg font-semibold mb-2" style="color: var(--color-primary);">Reminders</h3>
                    <div id="calendar-reminders-list" class="space-y-2 flex-grow overflow-y-auto pb-4">
                        <!-- JS will populate this -->
                        <p class="text-gray-500">Select a day to see its reminders.</p>
                    </div>
                </div>
            </div>

            <!-- ===== REMINDERS PAGE (Hidden by default) ===== -->
            <!-- [FIX] Added h-full and flex-col for scrolling list -->
            <div id="reminders-page" class="hidden h-full flex flex-col">
                <!-- Glass Header -->
                <header class="glass-card sticky top-0 z-10 px-4 py-3 rounded-b-2xl flex-shrink-0">
                    <h1 class="text-2xl font-bold text-center" style="color: var(--color-primary);">All Reminders</h1>
                </header>
                
                <!-- [FIX] This div will scroll -->
                <div id="reminders-list" class="flex-grow overflow-y-auto p-4 space-y-3">
                    <!-- JS will populate this -->
                </div>
            </div>

        </main>

        <!-- Floating Action Button (FAB) for adding reminders -->
        <!-- Only visible on the reminders page -->
        <button id="add-reminder-btn" class="hidden absolute z-20 bottom-24 right-6 p-4 rounded-full shadow-lg transition transform hover:scale-110" style="background-color: var(--color-primary);">
            <i data-lucide="plus" class="text-white"></i>
        </button>

        <!-- ===== BOTTOM TAB BAR ===== -->
        <nav id="tab-bar" class="glass-card fixed bottom-0 left-0 right-0 h-20 max-w-lg mx-auto rounded-t-2xl flex justify-around items-center z-30">
            <button class="tab-button flex flex-col items-center justify-center p-2 transition-all duration-300 ease-out" data-tab="calendar-page">
                <i data-lucide="calendar" class="icon"></i>
                <span class="text-xs font-medium">Calendar</span>
            </button>
            <button class="tab-button flex flex-col items-center justify-center p-2 transition-all duration-300 ease-out" data-tab="reminders-page">
                <i data-lucide="list-checks" class="icon"></i>
                <span class="text-xs font-medium">Reminders</span>
            </button>
        </nav>

        <!-- ===== ADD/EDIT REMINDER MODAL ===== -->
        <!-- [FIX] Use 90dvh for dynamic viewport height -->
        <div id="reminder-modal" class="glass-card fixed bottom-0 left-0 right-0 h-[90dvh] max-w-lg mx-auto rounded-t-3xl z-40 pt-2 flex flex-col">
            <!-- Modal Handle -->
            <div class="w-16 h-1.5 bg-gray-300 rounded-full mx-auto mb-3 cursor-grab pt-2" id="close-modal-handle"></div>
            
            <header class="flex justify-between items-center mb-4 px-4">
                <h2 id="modal-title" class="text-2xl font-bold" style="color: var(--color-primary);">New Reminder</h2>
                <button id="close-modal-btn" class="p-2 rounded-full hover:bg-gray-200 transition">
                    <i data-lucide="x" class="text-gray-600"></i>
                </button>
            </header>

            <!-- [FIX] Added pb-4 for extra space at bottom of scroll -->
            <form id="reminder-form" class="flex-grow overflow-y-auto space-y-4 px-4 pb-4">
                <!-- Hidden ID for editing -->
                <input type="hidden" id="reminder-id">
                
                <!-- Reminder Title -->
                <div>
                    <label for="reminder-title" class="block text-sm font-medium mb-1">Title</label>
                    <input type="text" id="reminder-title" class="ios-input" placeholder="e.g., Buy groceries" required>
                </div>

                <!-- Date and Time -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="min-w-0">
                        <label for="reminder-date" class="block text-sm font-medium mb-1">Date</label>
                        <input type="date" id="reminder-date" class="ios-input w-full" required>
                    </div>
                    <div class="min-w-0">
                        <label for="reminder-time" class="block text-sm font-medium mb-1">Time</label>
                        <input type="time" id="reminder-time" class="ios-input w-full" required>
                    </div>
                </div>

                <!-- Category -->
                <div>
                    <label for="reminder-category" class="block text-sm font-medium mb-1">Category</label>
                    <input type="text" id="reminder-category" class="ios-input" placeholder="e.g., Personal, Work" list="category-suggestions">
                    <!-- Datalist for category suggestions -->
                    <datalist id="category-suggestions">
                        <option value="Personal"></option>
                        <option value="Work"></option>
                        <option value="Shopping"></option>
                        <option value="Health"></option>
                        <option value="Urgent"></option>
                    </datalist>
                </div>

                <!-- Color Presets -->
                <div>
                    <label class="block text-sm font-medium mb-2">Color</label>
                    <div id="color-selector" class="flex justify-between items-center">
                        <!-- JS will populate color presets -->
                    </div>
                </div>
            </form>

            <!-- Modal Footer Buttons -->
            <div class="flex gap-3 pt-4 border-t border-gray-200 px-4 pb-6 modal-actions">
                <button id="delete-reminder" class="w-1/3 py-3 px-4 rounded-xl text-red-600 bg-red-100 font-semibold transition hover:bg-red-200 hidden">
                    Delete
                </button>
                <button id="save-reminder" class="flex-grow py-3 px-4 rounded-xl text-white font-semibold transition shadow" style="background-color: var(--color-primary);">
                    Save
                </button>
            </div>
        </div>

        <!-- ===== GENERIC ALERT/CONFIRM MODAL ===== -->
        <div id="alert-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-40 backdrop-blur-sm hidden">
            <div class="glass-card w-full max-w-sm rounded-2xl p-6 shadow-lg">
                <h3 id="alert-title" class="text-lg font-semibold text-center mb-2" style="color: var(--color-primary);"></h3>
                <p id="alert-message" class="text-center text-gray-700 mb-6"></p>
                <div id="alert-buttons" class="flex gap-3 justify-center">
                    <button id="alert-cancel" class="flex-grow py-2 px-4 rounded-xl bg-gray-200 text-gray-800 font-semibold transition hover:bg-gray-300">Cancel</button>
                    <button id="alert-confirm" class="flex-grow py-2 px-4 rounded-xl text-white font-semibold transition shadow" style="background-color: var(--color-primary);"></button>
                </div>
            </div>
        </div>

    </div> <!-- End #app-container -->


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // === STATE & CONSTANTS ===
            let reminders = [];
            let currentCalendarDate = new Date();
            let selectedDate = new Date();
            const STORAGE_KEY = 'everydate_reminders';
            
            const colorPresets = [
                '#D4A017', // Mustard
                '#C04B4B', // Muted Red
                '#3B8E7E', // Muted Teal
                '#29506A', // Slate
                '#5A3E6E', // Muted Purple
                '#6A6B29', // Olive Green
                '#D97706', // Muted Orange
            ];

            // Drag & Drop state
            let draggedItem = null;
            let isDragging = false; // To distinguish click from drag
            let pointerDownTimer = null;
            let dragClone = null;
            let placeholder = null;
            let dragOffsetY = 0;
            let pointerDownEvent = null;

            // [NEW] Swipe to Delete state
            let swipeStartX = 0;
            let swipeCurrentX = 0;
            let currentSwipedItem = null;
            let isSwiping = false;
            const swipeThreshold = -50; // Pixels to swipe left


            // === DOM ELEMENTS ===
            const appContainer = document.getElementById('app-container');
            const calendarPage = document.getElementById('calendar-page');
            const remindersPage = document.getElementById('reminders-page');
            const addReminderBtn = document.getElementById('add-reminder-btn');
            const tabButtons = document.querySelectorAll('.tab-button');
            
            // Calendar Elements
            const monthYearEl = document.getElementById('month-year');
            const calendarGrid = document.getElementById('calendar-grid');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const selectedDayHeader = document.getElementById('selected-day-header');
            const calendarRemindersList = document.getElementById('calendar-reminders-list');

            // Reminders List Element
            const remindersList = document.getElementById('reminders-list');

            // Modal Elements
            const modal = document.getElementById('reminder-modal');
            const modalTitle = document.getElementById('modal-title');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const closeModalHandle = document.getElementById('close-modal-handle');
            const saveReminderBtn = document.getElementById('save-reminder');
            const deleteReminderBtn = document.getElementById('delete-reminder');
            const reminderForm = document.getElementById('reminder-form');
            const colorSelector = document.getElementById('color-selector');
            
            // Alert Modal Elements
            const alertModal = document.getElementById('alert-modal');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            let alertCancelBtn = document.getElementById('alert-cancel');
            let alertConfirmBtn = document.getElementById('alert-confirm');
            
            // Form Inputs
            const reminderIdInput = document.getElementById('reminder-id');
            const reminderTitleInput = document.getElementById('reminder-title');
            const reminderDateInput = document.getElementById('reminder-date');
            const reminderTimeInput = document.getElementById('reminder-time');
            const reminderCategoryInput = document.getElementById('reminder-category');

            // === INITIALIZATION ===
            function init() {
                // Initialize Lucide icons
                lucide.createIcons();

                // Setup event listeners
                setupEventListeners();
                
                // [FIX] Renamed function
                setupDragAndSwipe();

                // Load data from localStorage
                loadReminders();

                // Populate color presets in the modal
                populateColorPresets();

                // Set initial tab
                showPage('calendar-page');

                // Render initial calendar and reminders
                renderCalendar();
                renderRemindersList();

                // Show reminders for the currently selected day (today)
                updateCalendarReminders(selectedDate);
            }
            
            // === EVENT LISTENERS ===
            function setupEventListeners() {
                // Tab navigation
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => showPage(button.dataset.tab));
                });

                // Calendar navigation
                prevMonthBtn.addEventListener('click', () => {
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                    renderCalendar();
                });
                nextMonthBtn.addEventListener('click', () => {
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                    renderCalendar();
                });

                // Calendar day selection
                calendarGrid.addEventListener('click', e => {
                    const dayEl = e.target.closest('.calendar-day');
                    if (dayEl && !dayEl.classList.contains('other-month')) {
                        const dateStr = dayEl.dataset.date;
                        selectedDate = new Date(dateStr + 'T00:00:00'); // Use local timezone
                        
                        // Update visual selection
                        document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected'));
                        dayEl.classList.add('selected');
                        
                        // Update reminder list
                        updateCalendarReminders(selectedDate);
                    }
                });

                // Open "New Reminder" modal
                addReminderBtn.addEventListener('click', () => openModal(null));

                // Close modal
                closeModalBtn.addEventListener('click', closeModal);
                closeModalHandle.addEventListener('click', closeModal);

                // Save/Delete reminder
                saveReminderBtn.addEventListener('click', handleFormSave);
                deleteReminderBtn.addEventListener('click', () => {
                     const id = reminderIdInput.value;
                     if (id) {
                        handleDeleteReminder(id, "Delete Reminder?", "Are you sure you want to permanently delete this reminder?");
                     }
                });

                // Color preset selection
                colorSelector.addEventListener('click', e => {
                    const colorBtn = e.target.closest('.color-preset');
                    if (colorBtn) {
                        document.querySelectorAll('.color-preset.selected').forEach(btn => btn.classList.remove('selected'));
                        colorBtn.classList.add('selected');
                    }
                });
                
                // [NEW] Click listener for the delete button (event delegation)
                remindersList.addEventListener('click', e => {
                    const deleteButton = e.target.closest('.swipe-delete');
                    if (deleteButton) {
                        const reminderItem = deleteButton.closest('.reminder-item');
                        const id = reminderItem.dataset.id;
                        handleDeleteReminder(id, "Delete Reminder?", "Are you sure?");
                    }
                });


                // Alert modal buttons
                alertCancelBtn.addEventListener('click', () => alertModal.classList.add('hidden'));
            }
            
            // === [FIX] DRAG AND SWIPE FUNCTIONS ===
            function setupDragAndSwipe() {
                
                // --- Pointer Down: Start logic for swipe or drag ---
                remindersList.addEventListener('pointerdown', e => {
                    // Don't interfere with vertical scrolling of the list
                    if (e.target.closest('.swipe-delete')) return; // Ignore clicks on delete button
                    
                    const reminderItem = e.target.closest('.reminder-item');
                    if (!reminderItem) return;

                    // Reset all states
                    isDragging = false;
                    isSwiping = false;
                    swipeStartX = e.clientX;
                    swipeCurrentX = e.clientX;
                    pointerDownEvent = e; // Store for later
                    
                    // If another item is swiped, reset it
                    if (currentSwipedItem && currentSwipedItem !== reminderItem) {
                        resetSwipes();
                    }

                    // Start timer for drag
                    pointerDownTimer = setTimeout(() => {
                        // Timer fired: INITIATE DRAG
                        isDragging = true;
                        isSwiping = false; // Can't be swiping if we're dragging
                        
                        // --- Start Drag Logic (from previous step) ---
                        draggedItem = reminderItem;
                        placeholder = document.createElement('div');
                        placeholder.className = 'reminder-placeholder';
                        const phRect = draggedItem.getBoundingClientRect();
                        const cs = window.getComputedStyle(draggedItem);
                        placeholder.style.height = `${phRect.height}px`;
                        placeholder.style.marginTop = cs.marginTop;
                        placeholder.style.marginBottom = cs.marginBottom;
                        placeholder.style.width = `${phRect.width}px`;
                        placeholder.style.boxSizing = 'border-box';

                        const rect = draggedItem.getBoundingClientRect();
                        dragOffsetY = pointerDownEvent.clientY - rect.top;
                        dragClone = draggedItem.cloneNode(true);
                        dragClone.classList.add('dragging-floating');
                        dragClone.style.position = 'fixed';
                        dragClone.style.left = `${rect.left}px`;
                        dragClone.style.top = `${rect.top}px`;
                        dragClone.style.width = `${rect.width}px`;
                        dragClone.style.zIndex = 9999;
                        dragClone.style.pointerEvents = 'none';
                        
                        draggedItem.parentNode.replaceChild(placeholder, draggedItem);
                        document.body.appendChild(dragClone);
                        document.body.style.overflow = 'hidden';
                        remindersList.style.touchAction = 'none';
                        // --- End Drag Logic ---

                    }, 200); // 200ms hold to drag

                });

                // --- Pointer Move: Handle dragging or swiping ---
                window.addEventListener('pointermove', e => {
                    if (isDragging) {
                        // --- Handle Drag Move ---
                        if (!dragClone || !placeholder) return;
                        e.preventDefault();
                        dragClone.style.top = `${e.clientY - dragOffsetY}px`;
                        const afterElement = getDragAfterElement(remindersList, e.clientY);
                        if (afterElement == null) {
                            remindersList.appendChild(placeholder);
                        } else {
                            remindersList.insertBefore(placeholder, afterElement);
                        }
                        // --- End Handle Drag Move ---

                    } else if (pointerDownEvent) {
                        // --- Handle Swipe Move ---
                        swipeCurrentX = e.clientX;
                        const deltaX = swipeCurrentX - swipeStartX;
                        
                        // Check if this is a horizontal swipe
                        if (Math.abs(deltaX) > 10 && !isSwiping) {
                            // It's a swipe, not a scroll or drag
                            isSwiping = true;
                            clearTimeout(pointerDownTimer); // Cancel the drag timer
                        }

                        if (isSwiping) {
                            e.preventDefault(); // Prevent vertical scroll
                            remindersList.style.touchAction = 'none';
                            const reminderItem = pointerDownEvent.target.closest('.reminder-item');
                            const content = reminderItem.querySelector('.reminder-item-content');
                            
                            // Only allow swiping left (negative delta)
                            const moveX = Math.max(-80, Math.min(0, deltaX)); // Clamp between -80 and 0
                            content.style.transition = 'none'; // No transition while dragging
                            content.style.transform = `translateX(${moveX}px)`;
                        }
                        // --- End Handle Swipe Move ---
                    }
                });

                // --- Pointer Up: Finalize click, drag, or swipe ---
                window.addEventListener('pointerup', e => {
                    clearTimeout(pointerDownTimer); // Always clear timer
                    
                    if (isDragging) {
                        // --- Finalize Drag ---
                        isDragging = false;
                        if (placeholder && placeholder.parentNode) {
                            placeholder.parentNode.replaceChild(draggedItem, placeholder);
                        } else if (draggedItem && !draggedItem.parentNode) {
                            remindersList.appendChild(draggedItem);
                        }
                        const newOrderedIds = [...remindersList.querySelectorAll('.reminder-item')].map(item => item.dataset.id);
                        reminders.sort((a, b) => newOrderedIds.indexOf(a.id) - newOrderedIds.indexOf(b.id));
                        if (dragClone && dragClone.parentNode) dragClone.parentNode.removeChild(dragClone);
                        placeholder = null; 
                        if(draggedItem) draggedItem.style.visibility = '';
                        draggedItem = null;
                        dragClone = null;
                        document.body.style.overflow = '';
                        remindersList.style.touchAction = 'auto';
                        saveReminders(); // Save new order
                        // --- End Finalize Drag ---

                    } else if (isSwiping) {
                        // --- Finalize Swipe ---
                        isSwiping = false;
                        remindersList.style.touchAction = 'auto';
                        const reminderItem = pointerDownEvent.target.closest('.reminder-item');
                        const content = reminderItem.querySelector('.reminder-item-content');
                        const deltaX = swipeCurrentX - swipeStartX;

                        content.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
                        
                        if (deltaX < swipeThreshold) {
                            // Swiped far enough: open delete
                            content.style.transform = 'translateX(-80px)';
                            reminderItem.classList.add('swiped');
                            currentSwipedItem = reminderItem;
                        } else {
                            // Not far enough: snap back
                            content.style.transform = 'translateX(0px)';
                            reminderItem.classList.remove('swiped');
                            currentSwipedItem = null;
                        }
                        // --- End Finalize Swipe ---

                    } else if (pointerDownEvent) {
                        // --- Finalize Click ---
                        // Check if the click was on the list itself (to reset swipes)
                        if (e.target.closest('#reminders-list') && !e.target.closest('.reminder-item') && currentSwipedItem) {
                            resetSwipes();
                        } else {
                            // Click was on an item, open modal
                            const reminderItem = pointerDownEvent.target.closest('.reminder-item');
                            if (reminderItem) openModal(reminderItem.dataset.id);
                        }
                        // --- End Finalize Click ---
                    }
                    
                    // Always clear the pointer down event
                    pointerDownEvent = null;
                });
            }

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.reminder-item')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            // [NEW] Reset any swiped items
            function resetSwipes() {
                if (currentSwipedItem) {
                    const content = currentSwipedItem.querySelector('.reminder-item-content');
                    if(content) {
                       content.style.transform = 'translateX(0px)';
                    }
                    currentSwipedItem.classList.remove('swiped');
                }
                currentSwipedItem = null;
            }


            // === ALERT & CONFIRM MODAL FUNCTIONS ===
            function showAlert(title, message) {
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                alertConfirmBtn.textContent = 'OK';
                alertCancelBtn.classList.add('hidden'); // Hide cancel button
                alertConfirmBtn.style.backgroundColor = 'var(--color-primary)';
                alertConfirmBtn.className = 'flex-grow py-2 px-4 rounded-xl text-white font-semibold transition shadow';
                
                alertModal.classList.remove('hidden');

                const newConfirmBtn = alertConfirmBtn.cloneNode(true);
                alertConfirmBtn.parentNode.replaceChild(newConfirmBtn, alertConfirmBtn);
                alertConfirmBtn = newConfirmBtn;
                
                alertConfirmBtn.addEventListener('click', () => {
                    alertModal.classList.add('hidden');
                }, { once: true });
            }

            function showConfirm(title, message, confirmText, onConfirm) {
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                alertConfirmBtn.textContent = confirmText;
                alertCancelBtn.textContent = 'Cancel';
                alertCancelBtn.classList.remove('hidden');
                
                alertConfirmBtn.style.backgroundColor = '#FF6B6B'; // Red
                alertConfirmBtn.className = 'flex-grow py-2 px-4 rounded-xl text-white font-semibold transition shadow';
                
                alertModal.classList.remove('hidden');

                const newConfirmBtn = alertConfirmBtn.cloneNode(true);
                alertConfirmBtn.parentNode.replaceChild(newConfirmBtn, alertConfirmBtn);
                alertConfirmBtn = newConfirmBtn;

                const newCancelBtn = alertCancelBtn.cloneNode(true);
                alertCancelBtn.parentNode.replaceChild(newCancelBtn, alertCancelBtn);
                alertCancelBtn = newCancelBtn;
                alertCancelBtn.addEventListener('click', () => alertModal.classList.add('hidden'), { once: true });


                alertConfirmBtn.addEventListener('click', () => {
                    onConfirm();
                    alertModal.classList.add('hidden');
                }, { once: true });
            }


            // === DATA FUNCTIONS (CRUD) ===
            function loadReminders() {
                const storedReminders = localStorage.getItem(STORAGE_KEY);
                reminders = storedReminders ? JSON.parse(storedReminders) : [];
            }

            function saveReminders() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(reminders));
            }

            function handleFormSave() {
                const id = reminderIdInput.value;
                const title = reminderTitleInput.value;
                const date = reminderDateInput.value;
                const time = reminderTimeInput.value;
                const category = reminderCategoryInput.value;
                const selectedColorEl = colorSelector.querySelector('.selected');
                const color = selectedColorEl ? selectedColorEl.dataset.color : colorPresets[0];

                if (!title || !date || !time) {
                    showAlert("Missing Information", "Please fill in Title, Date, and Time.");
                    return;
                }

                if (id) {
                    // Update existing reminder
                    const index = reminders.findIndex(r => r.id === id);
                    if (index > -1) {
                        reminders[index] = { ...reminders[index], title, date, time, category, color };
                    }
                } else {
                    // Create new reminder
                    const newReminder = {
                        id: Date.now().toString(),
                        title,
                        date,
                        time,
                        category,
                        color
                    };
                    reminders.push(newReminder); // Add to the end
                }

                saveAndRerender();
                closeModal();
            }

            // [FIX] Modified to accept ID and custom title/message
            function handleDeleteReminder(id, title, message) {
                if (!id) return;

                showConfirm(
                    title, 
                    message, 
                    "Delete", 
                    () => {
                        reminders = reminders.filter(r => r.id !== id);
                        saveAndRerender();
                        closeModal(); // Close modal if it's open
                    }
                );
            }
            
            function saveAndRerender() {
                saveReminders();
                resetSwipes(); // Close any open swipes
                renderRemindersList();
                renderCalendar();
                updateCalendarReminders(selectedDate);
            }
            
            // === PAGE NAVIGATION ===
            function showPage(pageId) {
                // Hide all pages
                calendarPage.classList.add('hidden');
                remindersPage.classList.add('hidden');
                
                // Hide FAB
                addReminderBtn.classList.add('hidden');

                // Show the target page
                const activePage = document.getElementById(pageId);
                if (activePage) {
                    activePage.classList.remove('hidden');
                }
                
                // Update tab bar
                tabButtons.forEach(button => {
                    if (button.dataset.tab === pageId) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                });

                // Show FAB on reminders page
                if (pageId === 'reminders-page') {
                    addReminderBtn.classList.remove('hidden');
                }

                // [NEW] Reset swipes when changing tabs
                resetSwipes();
            }

            // === CALENDAR RENDERING ===
            function renderCalendar() {
                calendarGrid.innerHTML = '';
                const month = currentCalendarDate.getMonth();
                const year = currentCalendarDate.getFullYear();

                monthYearEl.textContent = `${currentCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const prevMonthDays = new Date(year, month, 0).getDate(); // Days in previous month

                for (let i = 0; i < 42; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day w-10 h-10 flex flex-col items-center justify-center cursor-pointer p-1';

                    const day = i - firstDayOfMonth + 1;
                    
                    if (day > 0 && day <= daysInMonth) {
                        // Current month
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        dayEl.dataset.date = dateStr;
                        
                        const dateNumEl = document.createElement('span');
                        dateNumEl.textContent = day;
                        dayEl.appendChild(dateNumEl);

                        // Check for reminders
                        const remindersForDay = getRemindersForDate(dateStr);
                        if (remindersForDay.length > 0) {
                            const dotsContainer = document.createElement('div');
                            dotsContainer.className = 'flex';
                            
                            remindersForDay.slice(0, 3).forEach(r => {
                                const dot = document.createElement('div');
                                dot.className = 'reminder-dot';
                                dot.style.backgroundColor = r.color;
                                dotsContainer.appendChild(dot);
                            });
                            dayEl.appendChild(dotsContainer);
                        }

                        // Check if today
                        const today = new Date();
                        if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                            dayEl.classList.add('today');
                        }
                        
                        // Check if selected
                        if (day === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) {
                            dayEl.classList.add('selected');
                        }

                    } else {
                        // Other month
                        dayEl.classList.add('other-month');
                        
                        const dateNumEl = document.createElement('span');
                        if (day <= 0) {
                            dateNumEl.textContent = prevMonthDays + day;
                        } else {
                            dateNumEl.textContent = day - daysInMonth;
                        }
                        dayEl.appendChild(dateNumEl);
                    }

                    calendarGrid.appendChild(dayEl);
                }
            }

            function updateCalendarReminders(date) {
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                selectedDayHeader.textContent = `Reminders for ${date.toLocaleDateString('default', { month: 'long', day: 'numeric' })}`;
                
                const remindersForDay = getRemindersForDate(dateStr);
                remindersForDay.sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
                
                calendarRemindersList.innerHTML = '';

                if (remindersForDay.length === 0) {
                    calendarRemindersList.innerHTML = '<p class="text-gray-500">No reminders for this day.</p>';
                    return;
                }

                remindersForDay.forEach(reminder => {
                    const el = createReminderItem(reminder, false); // false = don't show date
                    calendarRemindersList.appendChild(el);
                });
                lucide.createIcons();
            }
            
            function getRemindersForDate(dateStr) {
                return reminders.filter(r => r.date === dateStr);
            }

            // === REMINDER LIST RENDERING ===
            function renderRemindersList() {
                remindersList.innerHTML = '';
                if (reminders.length === 0) {
                    remindersList.innerHTML = `
                        <div class="text-center p-10">
                            <i data-lucide="check-circle" class="w-16 h-16 text-gray-400 mx-auto"></i>
                            <p class="text-gray-500 mt-4">All clear! You have no reminders.</p>
                            <p class="text-gray-400 text-sm">Tap the '+' button to add one.</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }
                
                reminders.forEach(reminder => {
                    const el = createReminderItem(reminder, true); // true = show date
                    remindersList.appendChild(el);
                });
                lucide.createIcons();
            }

            function createReminderItem(reminder, showDate = true) {
                const el = document.createElement('div');
                // [FIX] Removed glass-card from here
                el.className = 'reminder-item flex items-center rounded-lg border-l-4';
                el.style.borderColor = reminder.color;
                el.dataset.id = reminder.id;
                
                const formattedTime = new Date(`1970-01-01T${reminder.time}`).toLocaleTimeString('default', { hour: 'numeric', minute: '2-digit', hour12: true });
                const formattedDate = new Date(reminder.date + 'T00:00:00').toLocaleDateString('default', { weekday: 'short', month: 'short', day: 'numeric' });

                function hexToRgba(hex, alpha) {
                    if (!hex) return `rgba(0,0,0,${alpha})`;
                    let cleaned = hex.replace('#', '');
                    if (cleaned.length === 3) {
                        cleaned = cleaned.split('').map(c => c + c).join('');
                    }
                    const r = parseInt(cleaned.substring(0,2), 16);
                    const g = parseInt(cleaned.substring(2,4), 16);
                    const b = parseInt(cleaned.substring(4,6), 16);
                    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                }

                const categoryHtml = reminder.category ? `<span class="category-inline" style="background-color: ${hexToRgba(reminder.color, 0.12)}; color: ${reminder.color};">${reminder.category}</span>` : '';

                // Add colored left accent and subtle outer border using the reminder color
                // Full colored border on all sides using the selected color
                el.style.border = `2px solid ${reminder.color}`;
                el.style.boxShadow = `0 6px 18px ${hexToRgba(reminder.color, 0.08)}`;

                // [NEW] HTML structure for swipe-to-delete
                el.innerHTML = `
                    <!-- [FIX] Added glass-card here -->
                    <div class="reminder-item-content p-3 rounded-lg flex-grow min-w-0 flex items-center cursor-pointer">
                        <div class="flex-grow min-w-0">
                            <p class="reminder-title">${reminder.title}</p>
                            <p class="reminder-details">
                                <i data-lucide="clock" class="inline-block w-3.5 h-3.5 mr-1"></i>
                                ${formattedTime} ${showDate ? ` - ${formattedDate}` : ''}
                                ${categoryHtml}
                            </p>
                        </div>
                    </div>
                    ${showDate ? `
                    <button class="swipe-delete">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                    ` : ''}
                `;
                // Remove inner element border to avoid double borders
                const inner = el.querySelector('.reminder-item-content');
                if (inner) inner.style.border = 'none';
                return el;
            }

            // === MODAL FUNCTIONS ===
            function openModal(reminderId) {
                // [NEW] Reset any open swipes before opening modal
                resetSwipes();

                reminderForm.reset();
                if (reminderId) {
                    // Edit mode
                    const reminder = reminders.find(r => r.id === reminderId);
                    if (reminder) {
                        modalTitle.textContent = "Edit Reminder";
                        reminderIdInput.value = reminder.id;
                        reminderTitleInput.value = reminder.title;
                        reminderDateInput.value = reminder.date;
                        reminderTimeInput.value = reminder.time;
                        reminderCategoryInput.value = reminder.category || '';
                        
                        document.querySelectorAll('.color-preset').forEach(btn => {
                            btn.classList.toggle('selected', btn.dataset.color === reminder.color);
                        });
                        
                        deleteReminderBtn.classList.remove('hidden');
                    }
                } else {
                    // New mode
                    modalTitle.textContent = "New Reminder";
                    reminderIdInput.value = '';
                    
                    reminderDateInput.value = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;
                    
                    document.querySelectorAll('.color-preset').forEach((btn, i) => {
                        btn.classList.toggle('selected', i === 0);
                    });
                    
                    deleteReminderBtn.classList.add('hidden');
                }
                modal.classList.add('is-open');
            }

            function closeModal() {
                modal.classList.remove('is-open');
            }

            function populateColorPresets() {
                colorSelector.innerHTML = '';

                const row = document.createElement('div');
                row.className = 'color-row';
                colorSelector.appendChild(row);

                colorPresets.forEach((color, index) => {
                    const colorBtn = document.createElement('button');
                    colorBtn.type = 'button';
                    colorBtn.className = 'color-preset';
                    colorBtn.dataset.color = color;
                    colorBtn.style.backgroundColor = color;
                    if (index === 0) {
                        colorBtn.classList.add('selected');
                    }
                    row.appendChild(colorBtn);
                });
            }

            // === START THE APP ===
            init();
        });
    </script>
</body>
</html>
